package com.my.board.dao;

import java.util.List;

import org.springframework.data.jdbc.repository.query.Modifying;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.test.annotation.Commit;
import org.springframework.transaction.annotation.Transactional;

import com.my.board.entity.Board;
import com.my.board.entity.Reply;
import com.my.exception.AddException;
import com.my.exception.FindException;
import com.my.exception.ModifyException;
import com.my.exception.RemoveException;

public interface BoardRepository extends JpaRepository<Board, Integer>{
	/**
	 * 게시글 목록을 검색한다
	 * @return 게시글 목록
	 * @throws FindException
	 */
	@Query(value="SELECT b.*,\r\n"
			+ "		(SELECT COUNT(*) FROM board_reply WHERE reply_board_no=b.board_no)replycnt\r\n"
			+ "		FROM board b\r\n"
			+ "		ORDER BY board_no DESC", nativeQuery = true)
	public List<Board> selectAll() throws FindException;
	
	
	@Query(value="SELECT *\r\n"
			+ "		FROM board b LEFT JOIN\r\n"
			+ "		(SELECT level,r1.* FROM\r\n"
			+ "		board_reply r1 START WITH reply_parent_no IS NULL\r\n"
			+ "		CONNECT BY PRIOR\r\n"
			+ "		reply_no = reply_parent_no\r\n"
			+ "		ORDER SIBLINGS BY reply_no DESC)r\r\n"
			+ "		ON\r\n"
			+ "		b.board_no = r.reply_board_no\r\n"
			+ "		WHERE board_no = :boardNo", nativeQuery = true)
	public Board selectByBoardNo(int boardNo) throws FindException;
	
	@Modifying
	@Query(value="INSERT INTO board(board_no, board_title, board_content, board_id)\r\n"
			+ "		VALUES (board_seq.NEXTVAL, :#{#board.boardTitle}, :#{#board.boardContent}, :#{#board.boardId})", nativeQuery = true)
	public void insertBoard(Board board) throws AddException;
	
	@Query(value="UPDATE board\r\n"
			+ "		SET board_content = :boardContent\r\n"
			+ "		WHERE board_no = :boardNo AND board_id = :boardId"
			, nativeQuery = true)	
	public void updateBoard(Board board) throws ModifyException;
	
	@Query(value="DELETE FROM board\r\n"
			+ "		WHERE board_no = :boardNo"
			, nativeQuery = true)
	public void deleteBoard(int boardNo) throws RemoveException;
	
	@Query(value="INSERT INTO board_reply2(reply_no, reply_board_no, reply_parent_no, reply_content,reply_id)\r\n"
			+ "		VALUES (reply_seq2.NEXTVAL, :replyBoardNo, :replyParentNo, :replyContent, :replyId)"
			, nativeQuery = true)
	public void insertReply(Integer replyBoardNo, Integer replyParentNo,
	        String replyContent,String replyId) throws AddException;
	
	@Query(value="UPDATE board_reply\r\n"
			+ "		SET reply_content=:replyContent\r\n"
			+ "		WHERE reply_no=:replyNo"
			, nativeQuery = true)
	public void updateReply(Reply reply) throws ModifyException;
	
	@Query(value="DELETE board_reply\r\n"
			+ "		WHERE reply_no=:replyNo"
			, nativeQuery = true)
	public void deleteReply(int replyNo) throws RemoveException;
	
}